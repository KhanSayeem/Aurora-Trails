@model TourismApp.Models.ViewModels.ManageBookingsVM
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@using TourismApp.Models
@{
    ViewData["Title"] = "Manage Bookings";
    var bookings = Model.Items ?? new List<TourismApp.Models.ViewModels.ManageBookingRow>();
}

<section class="space-y-8">
    <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
        <div>
            <h1 class="heading">Manage bookings</h1>
            <p class="section-subtitle">Oversee traveller timelines, confirm status, and reconcile payments.</p>
        </div>
    </div>

    @if (TempData["Msg"] is string ok)
    {
        <div class="rounded-2xl border border-emerald-200 bg-emerald-50 px-4 py-3 text-sm text-emerald-700 shadow-sm">@ok</div>
    }
    @if (TempData["Error"] is string err)
    {
        <div class="rounded-2xl border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-600 shadow-sm">@err</div>
    }

    <form method="get" class="card p-6">
        <div class="grid gap-4 md:grid-cols-2">
            <div class="form-field">
                <label asp-for="PackageId" class="form-label">Filter by package</label>
                <select asp-for="PackageId" class="input" asp-items="Model.PackageOptions" onchange="this.form.submit()">
                    <option value="">All packages</option>
                </select>
            </div>
        </div>
    </form>

    <div class="grid gap-4 md:grid-cols-2">
        <div class="card border border-transparent bg-white p-6 shadow-subtle">
            <p class="text-xs uppercase tracking-wide text-slate-400">Total participants</p>
            <p class="mt-3 text-2xl font-semibold text-slate-900">@Model.TotalParticipants</p>
        </div>
        <div class="card border border-transparent bg-white p-6 shadow-subtle">
            <p class="text-xs uppercase tracking-wide text-slate-400">Paid revenue</p>
            <p class="mt-3 text-2xl font-semibold text-slate-900">$@Model.TotalRevenuePaid</p>
        </div>
    </div>

    <div class="table-shell">
        <table>
            <thead>
                <tr>
                    <th>Package</th>
                    <th>Date</th>
                    <th>Tourist</th>
                    <th>Participants</th>
                    <th>Status</th>
                    <th>Payment</th>
                    <th class="text-right">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-slate-100">
            @foreach (var booking in bookings)
            {
                <tr>
                    <td class="px-4 py-3 text-sm font-semibold text-slate-900">@booking.PackageTitle</td>
                    <td class="px-4 py-3 text-sm text-slate-600">@booking.Date.ToString("yyyy-MM-dd")</td>
                    <td class="px-4 py-3 text-sm text-slate-600">@booking.TouristEmail</td>
                    <td class="px-4 py-3 text-sm text-slate-600">@booking.Participants</td>
                    <td class="px-4 py-3 text-sm text-slate-600">@booking.Status</td>
                    <td class="px-4 py-3 text-sm text-slate-600">@booking.PaymentStatus</td>
                    <td class="px-4 py-3 text-right">
                        <div class="flex flex-wrap justify-end gap-2">
                            @if (booking.Status == BookingStatus.Pending)
                            {
                                <form asp-action="SetStatus" method="post" class="inline-flex">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@booking.Id" />
                                    <input type="hidden" name="status" value="@BookingStatus.Confirmed" />
                                    <button class="btn-outline px-3 py-1 text-xs font-semibold">Confirm</button>
                                </form>
                                <form asp-action="SetStatus" method="post" class="inline-flex">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@booking.Id" />
                                    <input type="hidden" name="status" value="@BookingStatus.Cancelled" />
                                    <button class="btn-outline px-3 py-1 text-xs font-semibold text-rose-600 hover:bg-rose-50">Cancel</button>
                                </form>
                            }
                            else if (booking.Status == BookingStatus.Confirmed)
                            {
                                <form asp-action="SetStatus" method="post" class="inline-flex">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@booking.Id" />
                                    <input type="hidden" name="status" value="@BookingStatus.Completed" />
                                    <button class="btn-outline px-3 py-1 text-xs font-semibold text-emerald-600 hover:bg-emerald-50">Complete</button>
                                </form>
                                <form asp-action="SetStatus" method="post" class="inline-flex">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@booking.Id" />
                                    <input type="hidden" name="status" value="@BookingStatus.Cancelled" />
                                    <button class="btn-outline px-3 py-1 text-xs font-semibold text-rose-600 hover:bg-rose-50">Cancel</button>
                                </form>
                            }

                            @if (booking.Status != BookingStatus.Cancelled)
                            {
                                <form asp-action="SetPayment" method="post" class="inline-flex">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@booking.Id" />
                                    <input type="hidden" name="paymentStatus" value="@PaymentStatus.Unpaid" />
                                    <button class="btn-outline px-3 py-1 text-xs font-semibold">Unpaid</button>
                                </form>
                                <form asp-action="SetPayment" method="post" class="inline-flex">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@booking.Id" />
                                    <input type="hidden" name="paymentStatus" value="@PaymentStatus.Pending" />
                                    <button class="btn-outline px-3 py-1 text-xs font-semibold text-amber-600 hover:bg-amber-50">Partial</button>
                                </form>
                                <form asp-action="SetPayment" method="post" class="inline-flex">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@booking.Id" />
                                    <input type="hidden" name="paymentStatus" value="@PaymentStatus.Paid" />
                                    <button class="btn-outline px-3 py-1 text-xs font-semibold text-emerald-600 hover:bg-emerald-50">Paid</button>
                                </form>
                            }
                        </div>
                    </td>
                </tr>
            }
            </tbody>
        </table>
    </div>
</section>

